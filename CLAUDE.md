# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Lean 4 project for formal verification of Rust programs using the Aeneas toolchain. Rust code is translated to pure Lean functions, and proofs are written to verify properties about the Rust code.

## Build Commands

### Lean
```bash
lake build           # Build all Lean code
lake build LeanExperiment   # Build specific library
lake build VerifiedRust     # Build generated Rust translations
lake build SimpleProofs     # Build proofs about verified Rust
```

### Rust
```bash
cd rust
cargo test           # Run Rust tests
cargo build          # Build Rust code
```

### Aeneas Verification Workflow
```bash
cd rust
# Step 1: Extract Rust MIR with Charon
nix run github:aeneasverif/aeneas#charon
# Creates: verified_rust.llbc

# Step 2: Translate to Lean with Aeneas
nix run github:aeneasverif/aeneas -- -backend lean verified_rust.llbc
# Creates: Lean files (copy to project root as VerifiedRust.lean)
```

## Architecture

```
LeanExperiment/          # Manual Lean proofs and examples
  Example*_*.lean        # Educational examples (arithmetic, strings, monads, IO, validation)

rust/src/                # Rust code to verify
  simple.rs              # Functions translated by Aeneas

VerifiedRust.lean        # AUTO-GENERATED by Aeneas - do not edit manually
SimpleProofs.lean        # Proofs about the Aeneas-generated functions

lakefile.lean            # Lake build configuration
```

## Key Libraries

- **Aeneas**: Provides `Aeneas.Std`, `Result`, `U32`, and related types for representing Rust semantics in Lean
- **Mathlib**: Available via Aeneas dependencies for mathematical proofs

## Aeneas-Specific Patterns

### Result Type
Rust functions become Lean functions returning `Result T` to handle potential panics/overflows:
```lean
def simple.add (a : U32) (b : U32) : Result U32 := do
  a + b
```

### Proving Properties
Use `simp`, `omega`, and Aeneas lemmas (e.g., `U32.add_comm`, `U32.mul_one`):
```lean
theorem add_comm (a b : U32) (h : (a + b).isOk) :
    add a b = add b a := by
  simp only [add]
  rw [U32.add_comm]
```

### Partial Fixpoints
Recursive Rust functions use `partial_fixpoint` annotation in the generated Lean code.

## Rust Code Guidelines for Verification

Aeneas works best with:
- Pure functions (no global state)
- Safe Rust (no `unsafe` blocks)
- Bounded loops / recursion
- Simple data structures

Avoid: async/await, complex trait objects, FFI, most of std library.
